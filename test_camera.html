<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        video {
            width: 100%;
            max-width: 640px;
            border: 2px solid #333;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
        }
        .info {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error {
            background: #fee;
            border: 2px solid #c00;
            color: #c00;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #efe;
            border: 2px solid #0c0;
            color: #060;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Camera Test Tool</h1>
    <p>This page tests if your camera is accessible via the browser.</p>

    <div class="info">
        <strong>Protocol:</strong> <span id="protocol"></span><br>
        <strong>Hostname:</strong> <span id="hostname"></span><br>
        <strong>Browser:</strong> <span id="browser"></span>
    </div>

    <div id="status" class="info">Status: Ready to test</div>

    <button id="checkDevices">1. Check Available Cameras</button>
    <button id="startCamera">2. Start Camera</button>
    <button id="stopCamera" disabled>3. Stop Camera</button>

    <div id="deviceList"></div>
    <div id="error"></div>

    <video id="video" autoplay playsinline muted></video>

    <script>
        const video = document.getElementById('video');
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const deviceListDiv = document.getElementById('deviceList');
        let currentStream = null;

        // Display browser info
        document.getElementById('protocol').textContent = window.location.protocol;
        document.getElementById('hostname').textContent = window.location.hostname;
        document.getElementById('browser').textContent = navigator.userAgent;

        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            errorDiv.className = 'error';
            errorDiv.textContent = '❌ ERROR: getUserMedia is not supported in this browser';
            statusDiv.textContent = 'Status: Not Supported';
        } else {
            statusDiv.className = 'success';
            statusDiv.textContent = 'Status: getUserMedia is supported ✓';
        }

        // Check available devices
        document.getElementById('checkDevices').addEventListener('click', async () => {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                console.log('All devices:', devices);
                console.log('Video devices:', videoDevices);

                if (videoDevices.length === 0) {
                    deviceListDiv.className = 'error';
                    deviceListDiv.innerHTML = '<strong>❌ No cameras found!</strong><br>Make sure a camera is connected to your device.';
                } else {
                    deviceListDiv.className = 'success';
                    deviceListDiv.innerHTML = '<strong>✓ Cameras found:</strong><br>' +
                        videoDevices.map((device, i) =>
                            `${i + 1}. ${device.label || 'Camera ' + (i + 1)} (${device.deviceId.substring(0, 20)}...)`
                        ).join('<br>');
                }
            } catch (err) {
                console.error('Error enumerating devices:', err);
                deviceListDiv.className = 'error';
                deviceListDiv.textContent = '❌ Error checking devices: ' + err.message;
            }
        });

        // Start camera
        document.getElementById('startCamera').addEventListener('click', async () => {
            errorDiv.textContent = '';
            errorDiv.className = '';

            try {
                statusDiv.className = 'info';
                statusDiv.textContent = 'Status: Requesting camera access...';

                console.log('Requesting camera...');

                // Try to get camera stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                console.log('Camera stream obtained:', stream);
                console.log('Video tracks:', stream.getVideoTracks());

                currentStream = stream;
                video.srcObject = stream;

                statusDiv.className = 'success';
                statusDiv.textContent = '✓ Status: Camera is active!';

                document.getElementById('startCamera').disabled = true;
                document.getElementById('stopCamera').disabled = false;

                // Get updated device list with labels
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                deviceListDiv.className = 'success';
                deviceListDiv.innerHTML = '<strong>✓ Active camera:</strong><br>' +
                    videoDevices.map((device, i) =>
                        `${i + 1}. ${device.label} (${device.deviceId.substring(0, 20)}...)`
                    ).join('<br>');

            } catch (err) {
                console.error('Camera error:', err);
                console.error('Error name:', err.name);
                console.error('Error message:', err.message);

                errorDiv.className = 'error';
                statusDiv.className = 'error';

                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorDiv.textContent = '❌ Permission denied: Please click "Allow" when prompted for camera access.';
                    statusDiv.textContent = 'Status: Permission denied';
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorDiv.textContent = '❌ No camera found: Make sure a camera is connected to your device.';
                    statusDiv.textContent = 'Status: No camera detected';
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorDiv.textContent = '❌ Camera in use: Close other applications using the camera (Zoom, FaceTime, etc.)';
                    statusDiv.textContent = 'Status: Camera busy';
                } else if (err.name === 'OverconstrainedError') {
                    errorDiv.textContent = '❌ Camera constraints not supported: Your camera doesn\'t support the requested settings.';
                    statusDiv.textContent = 'Status: Constraint error';
                } else if (err.name === 'SecurityError') {
                    errorDiv.textContent = '❌ Security error: Make sure you\'re using http://localhost (not https with self-signed cert)';
                    statusDiv.textContent = 'Status: Security blocked';
                } else {
                    errorDiv.textContent = '❌ Unknown error: ' + err.name + ' - ' + err.message;
                    statusDiv.textContent = 'Status: Error';
                }
            }
        });

        // Stop camera
        document.getElementById('stopCamera').addEventListener('click', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    console.log('Stopping track:', track);
                    track.stop();
                });
                currentStream = null;
                video.srcObject = null;

                statusDiv.className = 'info';
                statusDiv.textContent = 'Status: Camera stopped';

                document.getElementById('startCamera').disabled = false;
                document.getElementById('stopCamera').disabled = true;
            }
        });
    </script>
</body>
</html>
