<!DOCTYPE html>
<html>
<head>
    <title>Camera Debug Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        video { border: 2px solid black; margin: 10px 0; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Camera Debug Test</h1>
    <button onclick="testCamera()">Start Camera</button>
    <button onclick="stopCamera()">Stop Camera</button>
    <br><br>
    <video id="video" width="640" height="480" autoplay playsinline></video>
    <br>
    <div id="log" class="log"></div>

    <script>
        let stream = null;
        const video = document.getElementById('video');
        const logDiv = document.getElementById('log');

        function log(message, isError = false) {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            p.className = isError ? 'error' : 'success';
            logDiv.appendChild(p);
            console.log(message);
        }

        async function testCamera() {
            try {
                log('=== Camera Test Started ===');

                // Check if API exists
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    log('❌ getUserMedia API not supported', true);
                    return;
                }
                log('✓ getUserMedia API available');

                // List all devices BEFORE requesting permission
                log('Enumerating devices BEFORE permission...');
                const devicesBefore = await navigator.mediaDevices.enumerateDevices();
                log(`Found ${devicesBefore.length} devices before permission`);
                devicesBefore.forEach((device, i) => {
                    log(`  ${i}: ${device.kind} - ${device.label || '(no label yet)'}`);
                });

                // Request camera access
                log('Requesting camera stream...');
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                log('✓ Camera stream obtained');

                // List devices AFTER permission
                log('Enumerating devices AFTER permission...');
                const devicesAfter = await navigator.mediaDevices.enumerateDevices();
                log(`Found ${devicesAfter.length} devices after permission`);
                devicesAfter.forEach((device, i) => {
                    log(`  ${i}: ${device.kind} - ${device.label}`);
                });

                // Check stream tracks
                const tracks = stream.getTracks();
                log(`Stream has ${tracks.length} tracks:`);
                tracks.forEach(track => {
                    log(`  Track: ${track.kind} - ${track.label}`);
                    log(`    Enabled: ${track.enabled}`);
                    log(`    Muted: ${track.muted}`);
                    log(`    ReadyState: ${track.readyState}`);
                    log(`    Settings: ${JSON.stringify(track.getSettings())}`);
                });

                // Attach to video element
                log('Attaching stream to video element...');
                video.srcObject = stream;
                video.muted = true;
                video.playsInline = true;

                // Wait for video to load
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        log(`✓ Video metadata loaded: ${video.videoWidth}x${video.videoHeight}`);
                        resolve();
                    };
                    video.onerror = (e) => {
                        log(`❌ Video element error: ${e}`, true);
                        reject(e);
                    };
                    setTimeout(() => reject(new Error('Timeout')), 5000);
                });

                // Start playback
                log('Starting video playback...');
                await video.play();
                log(`✓ Video playing - readyState: ${video.readyState}`);

                log('=== Camera Test SUCCESS ===');

            } catch (err) {
                log(`❌ ERROR: ${err.name}: ${err.message}`, true);
                log(`Full error: ${JSON.stringify(err, Object.getOwnPropertyNames(err))}`, true);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                stream = null;
                log('Camera stopped');
            }
        }
    </script>
</body>
</html>